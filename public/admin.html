<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KADÄ°S â€“ Admin Paneli</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-6xl bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl p-6 text-slate-50">
    <!-- Ãœst bar -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-blue-500 flex items-center justify-center font-extrabold">
          K
        </div>
        <div>
          <div class="text-sm font-semibold">KADÄ°S</div>
          <div class="text-[11px] text-slate-400">Kariyer DoÄŸrulama ve Ä°ÅŸ Sicil Sistemi â€“ Admin Paneli</div>
        </div>
      </div>
      <button
        id="logoutBtn"
        class="self-start md:self-auto bg-red-500 text-white text-xs font-semibold px-4 py-2 rounded-lg hover:bg-red-600">
        Ã‡Ä±kÄ±ÅŸ Yap
      </button>
    </div>

    <!-- Ãœst istatistikler -->
    <div id="overview" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6 text-sm">
      <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
        <div class="text-[11px] text-slate-400">Toplam Aday KaydÄ±</div>
        <div id="ov-totalCandidates" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
        <div class="text-[11px] text-slate-400">Aktif Aday</div>
        <div id="ov-activeCandidates" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
        <div class="text-[11px] text-slate-400">ArÅŸivlenmiÅŸ Aday</div>
        <div id="ov-archivedCandidates" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
        <div class="text-[11px] text-slate-400">Toplam Sorgu</div>
        <div id="ov-totalQueries" class="text-xl font-bold mt-1">-</div>
      </div>
    </div>

    <!-- KullanÄ±cÄ± sayÄ±larÄ± -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6 text-sm">
      <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
        <div class="text-[11px] text-slate-400">Aday KullanÄ±cÄ± SayÄ±sÄ±</div>
        <div id="ov-userCandidates" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
        <div class="text-[11px] text-slate-400">Ä°ÅŸveren KullanÄ±cÄ± SayÄ±sÄ±</div>
        <div id="ov-userEmployers" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
        <div class="text-[11px] text-slate-400">Admin KullanÄ±cÄ± SayÄ±sÄ±</div>
        <div id="ov-userAdmins" class="text-xl font-bold mt-1">-</div>
      </div>
    </div>

    <!-- Alt kÄ±sÄ±m: 3 tablo -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 text-xs">
      <!-- Adaylar -->
      <div class="bg-slate-950 border border-slate-800 rounded-lg p-3 flex flex-col">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-bold">Aday KayÄ±tlarÄ±</h2>
          <button id="refreshCandidates" class="text-[11px] text-blue-400 hover:text-blue-300">
            Yenile
          </button>
        </div>
        <div id="candidatesTable" class="flex-1 overflow-auto max-h-80">
          <p class="text-slate-500">YÃ¼kleniyor...</p>
        </div>
      </div>

      <!-- KullanÄ±cÄ±lar -->
      <div class="bg-slate-950 border border-slate-800 rounded-lg p-3 flex flex-col">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-bold">KullanÄ±cÄ±lar</h2>
          <button id="refreshUsers" class="text-[11px] text-blue-400 hover:text-blue-300">
            Yenile
          </button>
        </div>
        <div id="usersTable" class="flex-1 overflow-auto max-h-80">
          <p class="text-slate-500">YÃ¼kleniyor...</p>
        </div>
      </div>

      <!-- Sorgular -->
      <div class="bg-slate-950 border border-slate-800 rounded-lg p-3 flex flex-col">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-bold">Ä°ÅŸveren Sorgu GeÃ§miÅŸi</h2>
          <button id="refreshQueries" class="text-[11px] text-blue-400 hover:text-blue-300">
            Yenile
          </button>
        </div>
        <div id="queriesTable" class="flex-1 overflow-auto max-h-80">
          <p class="text-slate-500">YÃ¼kleniyor...</p>
        </div>
      </div>
    </div>

    <p class="mt-4 text-[11px] text-slate-500 text-center">
      Bu panel sadece sistem yÃ¶neticisi iÃ§indir. Demo ortamÄ±nda Ã§alÄ±ÅŸmaktadÄ±r.
    </p>
  </div>

  <script>
    // ðŸ”‘ ArtÄ±k tÃ¼m panellerde bu anahtarlarÄ± kullanÄ±yoruz
    const token = localStorage.getItem('kadis_token');
    const role  = localStorage.getItem('kadis_role');

    if (!token || role !== 'admin') {
      alert('Bu sayfayÄ± kullanmak iÃ§in Ã¶nce admin olarak KADÄ°S\'e giriÅŸ yapmalÄ±sÄ±nÄ±z.');
      window.location.href = '/login.html';
    }

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('kadis_token');
      localStorage.removeItem('kadis_role');
      window.location.href = '/login.html';
    });

    const headersAuth = {
      'Authorization': 'Bearer ' + token
    };

    // ---- Ä°statistikler (overview) ----
    async function loadOverview() {
      try {
        const res = await fetch('/api/admin/overview', {
          headers: headersAuth
        });
        if (!res.ok) throw new Error('Overview alÄ±namadÄ±');

        const data = await res.json();

        document.getElementById('ov-totalCandidates').textContent   = data.totalCandidates ?? '-';
        document.getElementById('ov-activeCandidates').textContent  = data.activeCandidates ?? '-';
        document.getElementById('ov-archivedCandidates').textContent = data.archivedCandidates ?? '-';
        document.getElementById('ov-totalQueries').textContent      = data.totalQueries ?? '-';

        document.getElementById('ov-userCandidates').textContent = data.usersByRole?.candidate ?? '-';
        document.getElementById('ov-userEmployers').textContent  = data.usersByRole?.employer ?? '-';
        document.getElementById('ov-userAdmins').textContent     = data.usersByRole?.admin ?? '-';
      } catch (err) {
        console.error(err);
        document.getElementById('ov-totalCandidates').textContent = 'Hata';
      }
    }

    // ---- Adaylar tablosu ----
    async function loadCandidates() {
      const wrap = document.getElementById('candidatesTable');
      wrap.innerHTML = '<p class="text-slate-500">YÃ¼kleniyor...</p>';

      try {
        const res = await fetch('/api/admin/candidates', { headers: headersAuth });
        if (!res.ok) throw new Error('Aday listesi alÄ±namadÄ±.');
        const list = await res.json();

        if (!list.length) {
          wrap.innerHTML = '<p class="text-slate-500">KayÄ±tlÄ± aday bulunamadÄ±.</p>';
          return;
        }

        const rows = list.map(item => {
          const status = item.isArchived ? 'ArÅŸivli' : 'Aktif';
          const created = item.createdAt ? new Date(item.createdAt).toLocaleString() : '-';
          const expires = item.expiresAt ? new Date(item.expiresAt).toLocaleString() : '-';

          return `
            <tr class="border-b border-slate-800 last:border-b-0">
              <td class="py-1 px-1 font-mono text-[11px]">${item.code}</td>
              <td class="py-1 px-1">${item.fullName || '-'}</td>
              <td class="py-1 px-1">${item.ownerEmail || '-'}</td>
              <td class="py-1 px-1">${status}</td>
              <td class="py-1 px-1 text-[11px]">${created}</td>
              <td class="py-1 px-1 text-[11px]">${expires}</td>
            </tr>
          `;
        }).join('');

        wrap.innerHTML = `
          <table class="w-full text-[11px]">
            <thead>
              <tr class="border-b border-slate-800">
                <th class="text-left py-1 px-1">Kod</th>
                <th class="text-left py-1 px-1">Ad Soyad</th>
                <th class="text-left py-1 px-1">Sahip E-posta</th>
                <th class="text-left py-1 px-1">Durum</th>
                <th class="text-left py-1 px-1">OluÅŸturma</th>
                <th class="text-left py-1 px-1">GeÃ§erlilik BitiÅŸi</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error(err);
        wrap.innerHTML = '<p class="text-red-400">Adaylar yÃ¼klenirken hata oluÅŸtu.</p>';
      }
    }

    // ---- KullanÄ±cÄ±lar tablosu ----
    async function loadUsers() {
      const wrap = document.getElementById('usersTable');
      wrap.innerHTML = '<p class="text-slate-500">YÃ¼kleniyor...</p>';

      try {
        const res = await fetch('/api/admin/users', { headers: headersAuth });
        if (!res.ok) throw new Error('KullanÄ±cÄ± listesi alÄ±namadÄ±.');
        const list = await res.json();

        if (!list.length) {
          wrap.innerHTML = '<p class="text-slate-500">KayÄ±tlÄ± kullanÄ±cÄ± bulunamadÄ±.</p>';
          return;
        }

        const rows = list.map(item => {
          const created = item.createdAt ? new Date(item.createdAt).toLocaleString() : '-';
          return `
            <tr class="border-b border-slate-800 last:border-b-0">
              <td class="py-1 px-1 break-all">${item.email}</td>
              <td class="py-1 px-1">${item.role}</td>
              <td class="py-1 px-1 text-[11px]">${created}</td>
            </tr>
          `;
        }).join('');

        wrap.innerHTML = `
          <table class="w-full text-[11px]">
            <thead>
              <tr class="border-b border-slate-800">
                <th class="text-left py-1 px-1">E-posta</th>
                <th class="text-left py-1 px-1">Rol</th>
                <th class="text-left py-1 px-1">OluÅŸturma</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error(err);
        wrap.innerHTML = '<p class="text-red-400">KullanÄ±cÄ±lar yÃ¼klenirken hata oluÅŸtu.</p>';
      }
    }

    // ---- Sorgular tablosu ----
    async function loadQueries() {
      const wrap = document.getElementById('queriesTable');
      wrap.innerHTML = '<p class="text-slate-500">YÃ¼kleniyor...</p>';

      try {
        const res = await fetch('/api/admin/queries', { headers: headersAuth });
        if (!res.ok) throw new Error('Sorgu listesi alÄ±namadÄ±.');
        const list = await res.json();

        if (!list.length) {
          wrap.innerHTML = '<p class="text-slate-500">HenÃ¼z yapÄ±lmÄ±ÅŸ sorgu bulunmuyor.</p>';
          return;
        }

        const rows = list.map(item => {
          const date = item.lookedAtAt ? new Date(item.lookedAtAt).toLocaleString() : '-';
          return `
            <tr class="border-b border-slate-800 last:border-b-0">
              <td class="py-1 px-1 break-all">${item.employerEmail || '-'}</td>
              <td class="py-1 px-1 font-mono text-[11px]">${item.code || '-'}</td>
              <td class="py-1 px-1">${item.candidateFullName || '-'}</td>
              <td class="py-1 px-1 text-[11px]">${date}</td>
            </tr>
          `;
        }).join('');

        wrap.innerHTML = `
          <table class="w-full text-[11px]">
            <thead>
              <tr class="border-b border-slate-800">
                <th class="text-left py-1 px-1">Ä°ÅŸveren E-posta</th>
                <th class="text-left py-1 px-1">KADÄ°S Kodu</th>
                <th class="text-left py-1 px-1">Aday</th>
                <th class="text-left py-1 px-1">Tarih</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error(err);
        wrap.innerHTML = '<p class="text-red-400">Sorgular yÃ¼klenirken hata oluÅŸtu.</p>';
      }
    }

    // Tombuslar
    document.getElementById('refreshCandidates').addEventListener('click', loadCandidates);
    document.getElementById('refreshUsers').addEventListener('click', loadUsers);
    document.getElementById('refreshQueries').addEventListener('click', loadQueries);

    // Ä°lk yÃ¼klemede her ÅŸeyi Ã§ek
    loadOverview();
    loadCandidates();
    loadUsers();
    loadQueries();
  </script>

</body>
</html>
