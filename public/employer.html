<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KADÄ°S â€“ Ä°ÅŸveren DoÄŸrulama</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- YazdÄ±rma (PDF) modunda sadece aday raporunu gÃ¶ster -->
  <style>
    @media print {
      body * {
        visibility: hidden !important;
      }
      #result, #result * {
        visibility: visible !important;
      }
      #result {
        position: absolute;
        inset: 0;
        margin: 0;
        padding: 16px;
      }
    }
  </style>
</head>
<body class="bg-slate-950 min-h-screen flex items-center justify-center">

  <div class="bg-slate-900 border border-slate-800 shadow-xl rounded-2xl p-8 w-full max-w-4xl text-slate-50">
    <!-- Ãœst bar: Logo + BaÅŸlÄ±k + Logout -->
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-3">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-blue-500 flex items-center justify-center font-extrabold text-slate-50">
          K
        </div>
        <div>
          <div class="font-semibold tracking-tight text-sm">KADÄ°S</div>
          <div class="text-[11px] text-slate-400">
            Kariyer DoÄŸrulama ve Ä°ÅŸ Sicil Sistemi â€“ Ä°ÅŸveren Paneli
          </div>
        </div>
      </div>
      <button
        id="logoutBtn"
        class="self-start md:self-auto bg-red-500 text-white text-xs font-semibold px-4 py-2 rounded-lg hover:bg-red-600">
        Ã‡Ä±kÄ±ÅŸ Yap
      </button>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      <!-- Sol: Kod sorgulama + rapor -->
      <div>
        <h1 class="text-xl font-bold mb-3">Aday DoÄŸrulama EkranÄ±</h1>
        <p class="text-xs text-slate-300 mb-4">
          AdayÄ±n size ilettiÄŸi KADÄ°S doÄŸrulama kodunu girerek, fotoÄŸraflÄ± ve Ã¶zetlenmiÅŸ profilini inceleyebilirsiniz.
          KADÄ°S kodlarÄ± oluÅŸturulduktan sonra <span class="font-semibold text-emerald-300">7 gÃ¼n boyunca geÃ§erlidir</span>.
          Adaydan gelen link veya QR kod ile aÃ§tÄ±ysanÄ±z, kod alanÄ± otomatik dolacaktÄ±r.
        </p>

        <form id="verifyForm" class="space-y-4">
          <div>
            <label class="font-semibold text-sm">KADÄ°S DoÄŸrulama Kodu</label>
            <input id="code" type="text"
              class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 mt-1 text-sm uppercase"
              required />
          </div>

          <div class="flex gap-2">
            <button type="submit"
              class="flex-1 bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 text-sm">
              Sorgula
            </button>

            <!-- PDF / YazdÄ±r butonu (baÅŸta gizli) -->
            <button type="button" id="printBtn"
              class="flex-1 bg-slate-700 text-white font-semibold py-2 rounded-lg hover:bg-slate-600 text-sm"
              style="display:none;">
              PDF / YazdÄ±r
            </button>
          </div>
        </form>

        <div id="result" class="text-left mt-6 text-slate-50"></div>
      </div>

      <!-- SaÄŸ: Ä°ÅŸveren Dashboard -->
      <div>
        <h2 class="text-lg font-bold mb-2">Son KADÄ°S SorgularÄ±nÄ±z</h2>
        <p class="text-xs text-slate-300 mb-3">
          Bu hesapla KADÄ°S Ã¼zerinden yaptÄ±ÄŸÄ±nÄ±z son aday sorgularÄ±:
        </p>
        <div id="myQueries" class="bg-slate-950 border border-slate-800 rounded-lg p-3 max-h-80 overflow-auto text-xs">
          <p class="text-slate-500">YÃ¼kleniyor...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('verifyForm');
    const resultDiv = document.getElementById('result');
    const myQueriesDiv = document.getElementById('myQueries');
    const printBtn = document.getElementById('printBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const codeInput = document.getElementById('code');

    // ðŸ”‘ Yeni anahtar isimleri
    const token = localStorage.getItem('kadis_token');
    const role  = localStorage.getItem('kadis_role');

    if (!token || role !== 'employer') {
      alert('Bu sayfayÄ± kullanmak iÃ§in Ã¶nce iÅŸveren olarak KADÄ°S\'e giriÅŸ yapmalÄ±sÄ±nÄ±z.');
      window.location.href = '/login.html';
    }

    function logout() {
      localStorage.removeItem('kadis_token');
      localStorage.removeItem('kadis_role');
      window.location.href = '/login.html';
    }

    logoutBtn.addEventListener('click', logout);

    async function loadMyQueries() {
      try {
        const res = await fetch('/api/my-queries', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          myQueriesDiv.innerHTML = '<p class="text-red-400">Sorgular yÃ¼klenemedi.</p>';
          return;
        }

        const list = await res.json();

        if (!list.length) {
          myQueriesDiv.innerHTML = '<p class="text-slate-500">HenÃ¼z KADÄ°S Ã¼zerinden sorgu yapÄ±lmamÄ±ÅŸ.</p>';
          return;
        }

        const rows = list.map(item => `
          <tr class="border-b border-slate-800 last:border-b-0">
            <td class="py-1 px-1 font-mono text-[11px]">${item.code}</td>
            <td class="py-1 px-1">${item.candidateFullName || '-'}</td>
            <td class="py-1 px-1 text-right text-[11px]">${new Date(item.lookedAtAt).toLocaleString()}</td>
          </tr>
        `).join('');

        myQueriesDiv.innerHTML = `
          <table class="w-full text-[11px]">
            <thead>
              <tr class="border-b border-slate-800">
                <th class="text-left py-1 px-1">KADÄ°S Kodu</th>
                <th class="text-left py-1 px-1">Aday</th>
                <th class="text-right py-1 px-1">Tarih</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error(err);
        myQueriesDiv.innerHTML = '<p class="text-red-400">Sunucu hatasÄ±.</p>';
      }
    }

    loadMyQueries();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const code = codeInput.value.trim();

      if (!code) {
        resultDiv.textContent = 'LÃ¼tfen bir KADÄ°S doÄŸrulama kodu girin.';
        printBtn.style.display = 'none';
        return;
      }

      try {
        const res = await fetch('/api/candidates/' + code, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        const data = await res.json();

        if (!res.ok) {
          resultDiv.innerHTML = `<p class="text-red-400 font-bold">${data.message}</p>`;
          printBtn.style.display = 'none';
          return;
        }

        const expText = data.expiresAt
          ? new Date(data.expiresAt).toLocaleString()
          : '-';

        const photoHtml = data.photoFilename
          ? `<div class="w-24 h-24 rounded-full overflow-hidden border border-slate-600">
               <img src="/uploads/${data.photoFilename}" alt="Aday fotoÄŸrafÄ±"
                    class="w-full h-full object-cover" />
             </div>`
          : `<div class="w-24 h-24 rounded-full border border-dashed border-slate-600 flex items-center justify-center text-[11px] text-slate-400">
               FotoÄŸraf yok
             </div>`;

        // SGK doÄŸrulama bilgisi
        const sgk = data.sgkVerification;
        let sgkHtml = '';
        if (sgk && sgk.status && sgk.status !== 'none') {
          let statusLabel = 'SGK DoÄŸrulamasÄ±: ÅžÃœPHELÄ°';
          if (sgk.status === 'verified') statusLabel = 'SGK DoÄŸrulamasÄ±: ONAYLANDI';
          else if (sgk.status === 'pending') statusLabel = 'SGK DoÄŸrulamasÄ±: Ä°NCELEME GEREKÄ°YOR';

          sgkHtml = `
            <div class="bg-slate-900 border border-slate-800 rounded-lg p-3">
              <h3 class="text-sm font-bold text-slate-100 mb-1">${statusLabel}</h3>
              <div class="text-[12px] text-slate-200">
                GÃ¼ven skoru: ${sgk.score}
              </div>
              ${sgk.notes ? `<div class="mt-1 text-[11px] text-slate-400">${sgk.notes}</div>` : ''}
            </div>
          `;
        }

        resultDiv.innerHTML = `
          <div class="bg-slate-950 border border-slate-800 rounded-xl p-4 space-y-4 mt-4">

            <!-- KADÄ°S baÅŸlÄ±ÄŸÄ± (PDF'de de gÃ¶rÃ¼necek) -->
            <div class="border-b border-slate-800 pb-2 mb-2">
              <div class="text-sm font-semibold">KADÄ°S â€“ Kariyer DoÄŸrulama ve Ä°ÅŸ Sicil Sistemi</div>
              <div class="text-[11px] text-slate-400">Resmi DoÄŸrulanmÄ±ÅŸ Profil Raporu</div>
            </div>

            <!-- Ãœst kÄ±sÄ±m: Foto + temel bilgiler + rozet/kod/tarih hepsi kart iÃ§inde -->
            <div class="flex items-start gap-3">
              ${photoHtml}
              <div class="flex-1">
                <h2 class="text-xl font-bold text-slate-50 break-words">${data.fullName}</h2>
                <p class="text-sm text-slate-300 break-all">${data.email}</p>
                <p class="mt-1 text-sm"><b>BaÅŸvurulan Pozisyon:</b> ${data.position || '-'}</p>

                <div class="mt-2 flex flex-wrap items-center gap-2 text-[11px] text-slate-300">
                  <span class="inline-block bg-emerald-500/20 text-emerald-300 font-semibold px-3 py-1 rounded-full">
                    KADÄ°S DoÄŸrulanmÄ±ÅŸ Profil
                  </span>
                  <span>|</span>
                  <span><b>KayÄ±t Tarihi:</b> ${data.createdAt}</span>
                  <span>|</span>
                  <span><b>KADÄ°S Kodu:</b> ${code.toUpperCase()}</span>
                  <span>|</span>
                  <span><b>Kod GeÃ§erlilik BitiÅŸi:</b> ${expText}</span>
                </div>
              </div>
            </div>

            <div class="bg-slate-900 border border-slate-800 rounded-lg p-3">
              <h3 class="text-sm font-bold text-slate-100 mb-2">Ã–ZET BÄ°LGÄ°LER (SimÃ¼le EdilmiÅŸ SGK Verisi)</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-slate-200">
                <div>
                  <span class="font-semibold">T.C. Kimlik No:</span>
                  <span class="ml-1">${data.nationalId || '-'}</span>
                </div>
                <div>
                  <span class="font-semibold">Toplam Prim GÃ¼nÃ¼:</span>
                  <span class="ml-1">${data.totalPrimDays || '-'}</span>
                </div>
                <div>
                  <span class="font-semibold">Son Ã‡alÄ±ÅŸtÄ±ÄŸÄ± Åžirket:</span>
                  <span class="ml-1">${data.lastCompany || '-'}</span>
                </div>
              </div>
            </div>

            ${sgkHtml}

            <div class="bg-slate-900 border border-slate-800 rounded-lg p-3">
              <h3 class="text-sm font-bold text-slate-100 mb-2">Ä°Åž GEÃ‡MÄ°ÅžÄ° / DENEYÄ°M Ã–ZETÄ°</h3>
              <pre class="whitespace-pre-wrap text-sm text-slate-200">${data.experience || '-'}</pre>
            </div>
          </div>
        `;

        // Sorgu sonrasÄ± dashboard'u gÃ¼ncelle
        loadMyQueries();

        // Rapor baÅŸarÄ±yla geldi, PDF butonunu gÃ¶ster
        printBtn.style.display = 'block';
      } catch (err) {
        console.error(err);
        resultDiv.textContent = 'Sunucuya baÄŸlanÄ±rken hata oluÅŸtu.';
        printBtn.style.display = 'none';
      }
    });

    // PDF / YazdÄ±r butonu davranÄ±ÅŸÄ±
    printBtn.addEventListener('click', () => {
      window.print();
    });

    // URL'den "code" parametresini yakala (QR veya link ile gelindiyse)
    const params = new URLSearchParams(window.location.search);
    const preCode = params.get('code');

    if (preCode) {
      codeInput.value = preCode.toUpperCase();
      // Sayfa yÃ¼klendiÄŸinde kod doluysa otomatik sorgula
      setTimeout(() => {
        form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
      }, 150);
    }
  </script>

</body>
</html>
